name: Deploy (Frontend: Shared, Backend: VPS)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-split
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Build frontend
        run: npm run build

      # --- SSH keys (Qiita方式: shimataro/ssh-key-action) ---
      # Shared用の鍵を ~/.ssh/id_rsa_shared に入れる
      - name: Install SSH key (Shared)
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SHARED_SSH_KEY }}
          name: id_rsa_shared
          known_hosts: ${{ secrets.SHARED_KNOWN_HOSTS }}

      # VPS用の鍵を ~/.ssh/id_rsa_vps に入れる
      - name: Install SSH key (VPS)
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          name: id_rsa_vps
          known_hosts: ${{ secrets.VPS_KNOWN_HOSTS }}

      # sshコマンド/rsyncが「どの鍵を使うか」迷わないように Host エイリアスを作る
      - name: Write SSH config
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host shared
            HostName ${SHARED_HOST}
            User ${SHARED_USER}
            IdentityFile ~/.ssh/id_rsa_shared
            IdentitiesOnly yes

          Host vps
            HostName ${VPS_HOST}
            User ${VPS_USER}
            IdentityFile ~/.ssh/id_rsa_vps
            IdentitiesOnly yes
          EOF

          # 変数を埋め込み（安全に置換）
          perl -pi -e 's/\$\{SHARED_HOST\}/$ENV{SHARED_HOST}/g' ~/.ssh/config
          perl -pi -e 's/\$\{SHARED_USER\}/$ENV{SHARED_USER}/g' ~/.ssh/config
          perl -pi -e 's/\$\{VPS_HOST\}/$ENV{VPS_HOST}/g' ~/.ssh/config
          perl -pi -e 's/\$\{VPS_USER\}/$ENV{VPS_USER}/g' ~/.ssh/config

          chmod 600 ~/.ssh/config
        env:
          SHARED_HOST: ${{ secrets.SHARED_HOST }}
          SHARED_USER: ${{ secrets.SHARED_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}

      # --- Frontend deploy to Shared (rsync) ---
      - name: Deploy frontend to Shared (rsync)
        shell: bash
        run: |
          set -euo pipefail
          rsync -avz --delete dist/ shared:${{ secrets.SHARED_WEB_ROOT }}

      # --- Backend deploy to VPS (git pull + npm ci + pm2 reload) ---
      - name: Deploy backend to VPS (git pull + pm2 reload)
        shell: bash
        run: |
          set -euo pipefail
          ssh vps << 'EOF'
            set -euo pipefail

            APP_DIR="/opt/transcriber-api"
            BRANCH="main"
            PM2_NAME="transcriber-api"

            cd "$APP_DIR"
            git fetch --all --prune
            git checkout "$BRANCH"
            git pull --ff-only origin "$BRANCH"

            # backend が server/ 配下なら次行を有効化
            # cd server

            npm ci --omit=dev

            pm2 describe "$PM2_NAME" >/dev/null 2>&1 && pm2 reload "$PM2_NAME" || pm2 start server.js --name "$PM2_NAME"
            pm2 save
          EOF
